<!-- pages/evaluation/evaluation.wxml -->
<view class="drawer-layout"
      bindtouchstart="onTouchStart"
      bindtouchmove="onTouchMove"
      bindtouchend="onTouchEnd">

  <!-- 左侧抽屉 -->
  <view class="drawer-panel {{drawerOpen ? 'open' : ''}}">
    <view class="drawer-header">
      <text class="drawer-title">评价要素</text>
      <button class="drawer-close" bindtap="closeDrawer">收起</button>
    </view>
    <scroll-view class="drawer-scroll" scroll-y>
      <view class="drawer-tabs">
        <view wx:for="{{tabs}}" wx:key="id"
              class="drawer-tab {{currentTab === index ? 'active' : ''}}"
              bindtap="switchTab"
              data-index="{{index}}">
          <text class="drawer-tab__text">{{item.name != null ? item.name : ''}}</text>
          <text class="drawer-tab__score" wx:if="{{item.robotScore != null}}">
            {{item.robotScore}}
          </text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 遮罩 -->
  <view class="drawer-overlay {{drawerOpen ? 'visible' : ''}}" bindtap="closeDrawer"></view>

  <view class="container main-content {{drawerOpen ? 'shifted' : ''}}" style="background-color: white;">
    <view class="drawer-trigger" bindtap="openDrawer">
      <text class="trigger-icon">|||</text>
      <text class="trigger-text">评价要素</text>
    </view>

    <!-- 当前页评分信息 -->
    <view class="score-banner" style="width:100%" wx:if="{{currentElement && currentElement.robotScore != null}}">
      <view class="score-banner__track">
        <text class="score-banner__label">当前评测页机器评分</text>
        <text class="score-banner__value">{{currentElement.robotScore}}</text>
      </view>
    </view>


    <!-- 评价内容区域 - 双向绑定 -->
    <view class="content-wrapper {{currentElement && (currentElement.completed === true || currentElement.completed === false) ? 'locked' : ''}}">
      <scroll-view class="content" scroll-y style="margin-bottom:210rpx;">
        <view wx:for="{{currentContents}}" wx:key="id" class="evaluation-item">
        <view class="item-header">
          <text class="item-title">{{item.title}}</text>
          <icon type="info" size="32"
                class="info-icon"
                data-title="{{item.title}}"
                data-desc="{{item.description}}"
                bindtap="showDescription" />
        </view>

        <!-- 选择器类型 -->
        <!-- 完成次数 - 所有类型都显示 -->
        <view class="scoring-area">
          <text class="score-label">完成次数：</text>
          <view class="score-controls">
            <!-- count类型：可以修改（已完成或待审核状态时禁用） -->
            <block wx:if="{{item.data.type=='count'}}">
              <button class="score-btn minus {{currentElement && (currentElement.completed === true || currentElement.completed === false) ? 'disabled' : ''}}" 
                      bindtap="decreaseScore" 
                      data-id="{{item.id}}"
                      disabled="{{currentElement && (currentElement.completed === true || currentElement.completed === false)}}">-</button>
              <input class="score-input" 
                     type="number" 
                     value="{{item.time}}"
                     bindinput="onScoreInput" 
                     data-id="{{item.id}}" 
                     placeholder="0"
                     disabled="{{currentElement && (currentElement.completed === true || currentElement.completed === false)}}"/>
              <button class="score-btn plus {{currentElement && (currentElement.completed === true || currentElement.completed === false) ? 'disabled' : ''}}" 
                      bindtap="increaseScore" 
                      data-id="{{item.id}}"
                      disabled="{{currentElement && (currentElement.completed === true || currentElement.completed === false)}}">+</button>
            </block>
            <!-- 非count类型：固定为1，不可修改 -->
            <block wx:else>
              <button class="score-btn minus disabled" disabled>-</button>
              <input class="score-input" type="number" value="1" disabled/>
              <button class="score-btn plus disabled" disabled>+</button>
            </block>
          </view>
        </view>

        <!-- 考核等级 - 非count类型显示（已完成或待审核状态时禁用） -->
        <view class="scoring-area-rad" wx:if="{{item.data.type!='count'}}">
            <text class="score-label-rad">考核等级：</text>
            <view class="radio-controls-rad" wx:for="{{item.data.data}}" wx:for-item="value" wx:key="name">
              <view class="radio-option {{currentLevel[item.id] && currentLevel[item.id].name === value.name ? 'selected' : ''}} {{currentElement && (currentElement.completed === true || currentElement.completed === false) ? 'disabled' : ''}}" 
                    bindtap="selectLevel"  
                    data-id="{{item.id}}" 
                    data-level="{{value.name}}" 
                    data-score="{{value.score}}">
                <text class="radio-text">{{value.name}}</text>
              </view>
            </view>
        </view>

        <view class="upload-section">
          <view class="desc-wrapper">
            <textarea class="desc-input"
                      placeholder="请输入材料说明（选填，最多200字）"
                      maxlength="200"
                      auto-height
                      value="{{item.uploadDesc}}"
                      data-id="{{item.id}}"
                      bindinput="onDescInput"
                      disabled="{{currentElement && (currentElement.completed === true || currentElement.completed === false)}}"></textarea>
          </view>

        <view class="file-row">
          <button class="file-btn {{currentElement && (currentElement.completed === true || currentElement.completed === false) ? 'disabled' : ''}}" 
                  bindtap="chooseFile" 
                  data-id="{{item.id}}"
                  disabled="{{currentElement && (currentElement.completed === true || currentElement.completed === false)}}">上传文件</button>
          <button class="file-btn camera-btn {{currentElement && (currentElement.completed === true || currentElement.completed === false) ? 'disabled' : ''}}" 
                  bindtap="chooseImage" 
                  data-id="{{item.id}}"
                  disabled="{{currentElement && (currentElement.completed === true || currentElement.completed === false)}}">拍照</button>
          <text class="file-limit">已选 {{(item.files && item.files.length) || 0}} / {{maxFilesPerItem}}</text>
        </view>

        <scroll-view class="files-list" wx:if="{{item.files && item.files.length}}" scroll-y>
          <view class="file-entry" wx:for="{{item.files}}" wx:key="index" wx:for-item="file">
            <text class="file-name">{{file.name}}</text>
            <view class="file-entry__meta">
              <text class="status-tag uploading" wx:if="{{file.status === 'uploading'}}">上传中...</text>
              <text class="status-tag pending" wx:elif="{{file.status === 'pending'}}">待上传</text>
              <text class="status-tag success" wx:elif="{{file.status === 'uploaded'}}">已上传</text>
              <text class="status-tag deleted" wx:elif="{{file.status === 'deleted'}}">待删除</text>
              <text class="status-tag error" wx:elif="{{file.status === 'failed'}}">{{file.error || '上传失败'}}</text>
              <view class="file-actions">
                <button class="action-btn preview-btn" bindtap="previewFile" data-id="{{item.id}}" data-index="{{index}}" wx:if="{{file.status !== 'deleted'}}">预览</button>
                <button class="action-btn delete-btn" bindtap="removeFile" data-id="{{item.id}}" data-index="{{index}}" wx:if="{{!file.isRemote}}">删除</button>
                <button class="action-btn delete-btn {{file.status === 'deleted' ? 'restore' : ''}}" bindtap="removeFile" data-id="{{item.id}}" data-index="{{index}}" wx:if="{{file.isRemote}}">
                  {{file.status === 'deleted' ? '恢复' : '删除'}}
                </button>
              </view>
            </view>
          </view>
        </scroll-view>
        </view>
      </view>
      </scroll-view>
      
      <!-- 锁住遮罩层 -->
      <!-- completed=true：评价已完成，完全锁住，显示最终得分 -->
      <view class="lock-overlay" wx:if="{{currentElement && currentElement.completed === true}}">
        <view class="lock-message compact">
          <view class="final-score-container {{currentElement.finalScore > 5000 ? 'score-pass' : (currentElement.finalScore < -5000 ? 'score-fail' : 'score-normal')}}">
            <text class="final-score-title">最终得分</text>
            <view class="final-score-display">
              <text class="final-score-value">
                {{currentElement.finalScore > 5000 ? '合格' : (currentElement.finalScore < -5000 ? '不合格' : currentElement.finalScore)}}
              </text>
            </view>
          </view>
        </view>
      </view>
      <!-- completed=false：待审核中，半透明可看到内容 -->
      <view class="lock-overlay pending" wx:elif="{{currentElement && currentElement.completed === false}}">
        <view class="lock-message">
          <text class="lock-text">待审核中</text>
        </view>
      </view>
    </view>

    <!-- 底部按钮 -->
    <view class="footer">
      <!-- completed=false 或未设置：显示正常按钮 -->
      <block wx:if="{{!currentElement || currentElement.completed === null}}">
        <button class="btn submit-btn {{canSubmit ? '' : 'disabled'}}" bindtap="submitEvaluation" disabled="{{!canSubmit}}">提交评价</button>
        <button class="btn audit-btn {{auditEnabled ? '' : 'disabled'}}" bindtap="submitAudit" disabled="{{!auditEnabled}}">提交审核</button>
      </block>
      <!-- completed=false：显示取消审核按钮 -->
      <block wx:elif="{{currentElement && currentElement.completed === false}}">
        <button class="btn cancel-audit-btn" bindtap="cancelAudit">取消审核</button>
      </block>
      <button class="btn back-btn" bindtap="navigateBack">返回</button>
    </view>
  </view>
</view>