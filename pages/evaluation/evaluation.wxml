<!-- pages/evaluation/evaluation.wxml -->
<view class="drawer-layout"
      bindtouchstart="onTouchStart"
      bindtouchmove="onTouchMove"
      bindtouchend="onTouchEnd">

  <!-- 左侧抽屉 -->
  <view class="drawer-panel {{drawerOpen ? 'open' : ''}}">
    <view class="drawer-header">
      <text class="drawer-title">评价要素</text>
      <button class="drawer-close" bindtap="closeDrawer">收起</button>
    </view>
    <scroll-view class="drawer-scroll" scroll-y>
      <view class="drawer-tabs">
        <view wx:for="{{tabs}}" wx:key="id"
              class="drawer-tab {{currentTab === index ? 'active' : ''}}"
              bindtap="switchTab"
              data-index="{{index}}">
          <text class="drawer-tab__text">{{item.name != null ? item.name : ''}}</text>
          <text class="drawer-tab__score" wx:if="{{item.robotScore != null}}">
            {{item.robotScore >= 5000 ? '合格' : (item.robotScore <= -5000 ? '不合格' : (item.robotScore != null ? item.robotScore : 0))}}
          </text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 遮罩 -->
  <view class="drawer-overlay {{drawerOpen ? 'visible' : ''}}" bindtap="closeDrawer"></view>

  <view class="container main-content {{drawerOpen ? 'shifted' : ''}}" style="background-color: white;">
    <view class="drawer-trigger" bindtap="openDrawer">
      <text class="trigger-icon">|||</text>
      <text class="trigger-text">评价要素</text>
    </view>

    <!-- 当前页评分信息 -->
    <!--
    <view class="score-banner" style="width:100%" wx:if="{{currentElement && currentElement.robotScore != null}}">
      <view class="score-banner__track">
        <text class="score-banner__label">当前评测页机器评分</text>
        <text class="score-banner__value">{{currentElement.robotScore}}</text>
      </view>
    </view>
    -->


    <!-- 评价内容区域 - 双向绑定 -->
    <view class="content-wrapper">
      <scroll-view class="content" scroll-y style="margin-bottom:210rpx;">
        <view wx:for="{{currentContents}}" wx:key="id" class="evaluation-item">
        <view class="item-header">
          <text class="item-title">{{item.title}}</text>
          <text class="item-score" wx:if="{{item.score != null}}">
            <block wx:if="{{isReview}}">
              权值：{{item.score >= 5000 ? '合格' : (item.score <= -5000 ? '不合格' : (item.score != null ? item.score : 0))}}
              （最终得分：{{item.finalScore >= 5000 ? '合格' : (item.finalScore <= -5000 ? '不合格' : (item.finalScore != null ? item.finalScore : 0))}}）
            </block>
            <block wx:else>
              权值：{{item.score >= 5000 ? '合格' : (item.score <= -5000 ? '不合格' : (item.score != null ? item.score : 0))}}
              （当前得分：{{item.totalScore >= 5000 ? '合格' : (item.totalScore <= -5000 ? '不合格' : (item.totalScore != null ? item.totalScore : 0))}}）
            </block>
          </text>
          <icon type="info" size="32"
                class="info-icon"
                data-title="{{item.title}}"
                data-desc="{{item.description}}"
                bindtap="showDescription" />
        </view>

        <!-- 完成次数 - 仅当需要上传材料时显示 -->
        <view class="scoring-area" wx:if="{{item.isNeedUploadFile}}">
          <text class="score-label">完成次数：</text>
          <view class="score-controls">
            <!-- count类型：可以修改（已完成或待审核状态时禁用） -->
            <block wx:if="{{item.data.type=='count'}}">
              <button class="score-btn minus {{interactionLocked ? 'disabled' : ''}}" 
                      bindtap="decreaseScore" 
                      data-id="{{item.id}}"
                      disabled="{{interactionLocked}}">-</button>
              <input class="score-input" 
                     type="number" 
                     value="{{item.time}}"
                     bindinput="onScoreInput" 
                     data-id="{{item.id}}" 
                     placeholder="0"
                     disabled="{{interactionLocked}}"/>
              <button class="score-btn plus {{interactionLocked ? 'disabled' : ''}}" 
                      bindtap="increaseScore" 
                      data-id="{{item.id}}"
                      disabled="{{interactionLocked}}">+</button>
            </block>
            <!-- 非count类型：固定为1，不可修改 -->
            <block wx:else>
              <button class="score-btn minus disabled" disabled>-</button>
              <input class="score-input" type="number" value="1" disabled/>
              <button class="score-btn plus disabled" disabled>+</button>
            </block>
          </view>
        </view>

        <!-- 考核等级 - 非count类型显示（已完成或待审核状态时禁用） -->
        <view class="scoring-area-rad" wx:if="{{item.data.type!='count'}}">
            <text class="score-label-rad">考核等级：</text>
            <view class="radio-controls-rad" wx:for="{{item.data.data}}" wx:for-item="value" wx:key="name">
              <view class="radio-option {{currentLevel[item.id] && currentLevel[item.id].name === value.name ? 'selected' : ''}} {{interactionLocked ? 'disabled' : ''}}" 
                    bindtap="selectLevel"  
                    data-id="{{item.id}}" 
                    data-level="{{value.name}}" 
                    data-score="{{value.score}}">
                <text class="radio-text">{{value.name}}</text>
              </view>
            </view>
        </view>

        <!-- 材料说明 + 上传文件区域：仅当需要上传材料时显示 -->
        <view class="upload-section" wx:if="{{item.isNeedUploadFile}}">
          <view class="desc-wrapper">
            <textarea class="desc-input"
                      placeholder="请输入材料说明（选填，最多200字）"
                      maxlength="200"
                      auto-height
                      value="{{item.uploadDesc}}"
                      data-id="{{item.id}}"
                      bindinput="onDescInput"
                      disabled="{{interactionLocked}}"></textarea>
          </view>

        <view class="file-row">
          <button class="file-btn {{interactionLocked ? 'disabled' : ''}}" 
                  bindtap="chooseFile" 
                  data-id="{{item.id}}"
                  disabled="{{interactionLocked}}">上传文件</button>
          <button class="file-btn camera-btn {{interactionLocked ? 'disabled' : ''}}" 
                  bindtap="chooseImage" 
                  data-id="{{item.id}}"
                  disabled="{{interactionLocked}}">拍照</button>
          <text class="file-limit">已选 {{(item.files && item.files.length) || 0}} / {{maxFilesPerItem}}</text>
        </view>

        <scroll-view class="files-list" wx:if="{{item.files && item.files.length}}" scroll-y>
          <view class="file-entry" wx:for="{{item.files}}" wx:key="index" wx:for-item="file">
            <text class="file-name">{{file.name}}</text>
            <view class="file-entry__meta">
              <text class="status-tag uploading" wx:if="{{file.status === 'uploading'}}">上传中...</text>
              <text class="status-tag pending" wx:elif="{{file.status === 'pending'}}">待上传</text>
              <text class="status-tag success" wx:elif="{{file.status === 'uploaded'}}">已上传</text>
              <text class="status-tag deleted" wx:elif="{{file.status === 'deleted'}}">待删除</text>
              <text class="status-tag error" wx:elif="{{file.status === 'failed'}}">{{file.error || '上传失败'}}</text>
              <view class="file-actions">
                <button class="action-btn preview-btn" bindtap="previewFile" data-id="{{item.id}}" data-index="{{index}}" wx:if="{{file.status !== 'deleted'}}">预览</button>
                <button class="action-btn delete-btn" bindtap="removeFile" data-id="{{item.id}}" data-index="{{index}}" wx:if="{{!file.isRemote}}">删除</button>
                <button class="action-btn delete-btn {{file.status === 'deleted' ? 'restore' : ''}}" bindtap="removeFile" data-id="{{item.id}}" data-index="{{index}}" wx:if="{{file.isRemote}}">
                  {{file.status === 'deleted' ? '恢复' : '删除'}}
                </button>
              </view>
            </view>
          </view>
        </scroll-view>
        </view>
      </view>
      </scroll-view>
      
    </view>

    <!-- 底部按钮 -->
    <view class="footer">
      <!-- 所有 isLeaderGrade=true：等待上级确认，不可操作 -->
      <button wx:if="{{showWaitingLeader}}"
              class="btn audit-btn disabled"
              disabled="true">
        等待上级确认
      </button>

      <!-- 撤销审核按钮 -->
      <button wx:elif="{{showWithdraw}}"
              class="btn audit-btn"
              bindtap="withdrawAudit">
        撤销审核
      </button>

      <!-- 已锁定但不可撤销：显示已审核，按钮不可点 -->
      <button wx:elif="{{isReview}}"
              class="btn audit-btn disabled"
              disabled="true">
        已审核
      </button>

      <!-- 正常提交审核按钮 -->
      <button wx:else
              class="btn audit-btn {{(!interactionLocked && canSubmit) ? '' : 'disabled'}}"
              bindtap="submitAudit"
              disabled="{{interactionLocked || !canSubmit}}">
        提交审核
      </button>

      <button class="btn back-btn" bindtap="navigateBack">返回</button>
    </view>
  </view>
</view>